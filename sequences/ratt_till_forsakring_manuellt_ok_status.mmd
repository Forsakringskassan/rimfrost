sequenceDiagram
    title Kunden har rätt till försäkringen efter manuell utredning
    participant Kund
    participant VAH_flode
    participant RTF_rule_automatic
    participant RTF_rule_manual
    participant status_subscribers
    participant folkbokford
    participant arbetsgivare
    participant uppgiftslager
    participant handlaggare

    Kund ->> VAH_flode: Swagger: VAH ansökan (personnummer)
    note over VAH_flode: new processId
    VAH_flode ->> RTF_rule_automatic: Kafka: VahRtfRequestMessage (processId, personnummer)
    RTF_rule_automatic ->> folkbokford: API: GET /folkbokford/{personnummer}
    folkbokford -->> RTF_rule_automatic: True
    RTF_rule_automatic ->> arbetsgivare: API:  GET /arbetsgivare/{personnummer}
    arbetsgivare -->> RTF_rule_automatic: False
    note over RTF_rule_automatic: kolla om regel uppfylld
    RTF_rule_automatic ->> VAH_flode: Kafka: VahRtfResponseMessage (processId, personnummer, NEJ)
    note over VAH_flode: Ej godkänt. Starta manuell utredning
    VAH_flode ->> RTF_rule_manual: Kafka: VahRtfRequestMessage (processId, personnummer)
    RTF_rule_manual ->> uppgiftslager: Kafka: UppgiftRequest (uppgift: "VAH_RTF")
    uppgiftslager ->> status_subscribers: Kafka: UppgiftStatus (Ny)
    handlaggare ->> uppgiftslager: API: POST /uppgifter/{handlaggare_id}/next
    uppgiftslager -->> handlaggare: {uppgift_id: "VAH_RTF"}
    uppgiftslager ->> status_subscribers: Kafka: UppgiftStatus (Tilldelad)
    note over handlaggare: Handläggare utför manuell uppgift
    handlaggare ->> uppgiftslager: API: PATCH /task/{handlaggare_id}/{uppgift_id} (update state)
    uppgiftslager -->> handlaggare: OK
    uppgiftslager ->> status_subscribers: Kafka: UppgiftStatus (Avslutad)
    uppgiftslager ->> RTF_rule_manual: Kafka: UppgiftResponse (uppgift_id, handlaggare_id, state)
    note over RTF_rule_manual: kolla om regel uppfylld
    RTF_rule_manual ->> VAH_flode: Kafka: VahRtfResponseMessage (processId, personnummer, JA)
    VAH_flode ->> Kund: Kafka: VAH ansökan resultat (processId, personnummer, Godkänd)
